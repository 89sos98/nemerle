(* ------------------------------------------------------------------------- *)
(*   Shift-Or exact string matching algorithm                                *)
(*                                                                           *)
(*   See ESMAJ: http://www-igm.univ-mlv.fr/~lecroq/string/node6.html         *)
(* ------------------------------------------------------------------------- *)

(* NOTE: there's a bug in this program but I was too lazy to fix it ;)       *)

class ShiftOr
{
  private mutable _pattern : array (char);
  private mutable _pattern_length : int;
  private mutable _R : System.Collections.BitArray;
  private mutable _S : array (System.Collections.BitArray);
  private mutable _L : System.Collections.BitArray;
 
  private shift_left (mask : System.Collections.BitArray) : void {
  
    def shift (index : int) : void {
    
      if (index >= 0) {
      
        mask.Set (index + 1, mask.Get (index));
        mask.Set (index, false);
      
        shift (index - 1)
      }
      else ()
    }
    
    shift (mask.Length - 2)
  }
  
  private shift_right (mask : System.Collections.BitArray) : void {
  
    def shift (index : int) : void {
    
      if (index < mask.Length) {
      
        mask.Set (index - 1, mask.Get (index));
        mask.Set (index, false);
      
        shift (index + 1)
      }
      else ()
    }
    
    shift (1)
  }
    
  private init_S (index : int) : void
  {
    if (index < 256)
    {
      this._S [index] <- System.Collections.BitArray (this._pattern_length, true);
    
      this.init_S (index + 1)
    }
    else ()    
  }
    
  private build_S (index : int) : void
  {
    if (index < this._pattern_length)
    {
      if ((this._pattern [index] :> int) >= 256)
        raise Invalid_argument ("_pattern")
      else ();
      
      mutable mask <- System.Collections.BitArray (this._pattern_length, true);
      mask.Set (index, false);
      def current_char = (this._pattern [ index ] :> int); 
      def s = this._S [ current_char ];
      this._S [ current_char ] <- s.And (mask);

      mask <- mask.Not ();      
      this._L <- this._L.Or (mask);
                      
      this.build_S (index + 1)
    }
    else ()
  }
    
  public this (pattern : string) 
  {
    this._pattern <- pattern.ToCharArray ();  
    this._pattern_length <- pattern.Length;
    
    this._L <- System.Collections.BitArray (this._pattern_length, false);
    
    this._S <- (System.Array.CreateInstance (this._L.GetType (), 256) :> array (System.Collections.BitArray));
    
    this.init_S (0);
    this.build_S (0);
    
    this.shift_right (this._L);
    this._L <- this._L.Not ()  
  }
  
  public Search (text : string) : option (int)
  {
    this._R <- System.Collections.BitArray (this._pattern_length, true);

    def text = text.ToCharArray ();
    
    def le (index : int, l : System.Collections.BitArray, r : System.Collections.BitArray) : bool
    {
      if (index < l.Length) {
      
        if (l.Get (index) == false && r.Get (index) == true)
          true
        else      
          le (index - 1, l, r)
      }
      else false
    }
    
    def loop (index : int) : option (int)
    {
      if (index < (text :> System.Array).Length) {

        this.shift_left (this._R);
        this._R <- this._R.Or (this._S [ (text [ index ] :> int) ]);

        if (le (this._R.Length, this._R, this._L))
          Some (index)
        else
          loop (index + 1)      
      }
      else None ();
    }
      
    loop (0)
  }
  
  public static Main () : void {
 
    def r = ShiftOr ("kot");
    
    match (r.Search ("ala ma kota")) {
      | Some (i) => print_endline ("Found at index " + string_of_int (i))
      | None => print_endline ("Not found")
    }
  }
}