/** this is test program for accesing sql databse
    as for now it requires Postgres database server running on localhost
    with database user 'postgres' (password 'sql')
 */

// REFERENCE: Npgsql.dll
// REFERENCE: ../macros/Nemerle.Data.Npgsql.dll

using System;
using System.Data;
using Npgsql;
 
public class Test 
 {
    static insert (conn : NpgsqlConnection, x : string, y : string) : void
    {
       Nemerle.Data.Npgsql.CreateCompileTimeConnection ("Server=127.0.0.1;Database=test;"
                                                        "User ID=postgres;Password=sql;");
      
       ignore (Nemerle.Data.Npgsql.ExecuteNonQuery ("INSERT INTO employee VALUES ($x, $y)",
                                                    conn));
    }

    public static Main() : void
    {
       Console.WriteLine("start...");


       def connectionString = 
          "Server=localhost;" +
          "Database=test;" +
          "User ID=postgres;" +
          "Password=sql;";

       def dbcon = Npgsql.NpgsqlConnection (connectionString);
       dbcon.Open ();
       Console.WriteLine("connection opened...");

//       insert (dbcon, "Kocia", "Bicia");

       // requires a table to be created named employee
       // with columns firstname and lastname
       // such as,
       //        CREATE TABLE employee (
       //           firstname varchar(32),
       //           lastname varchar(32));
       def a = "Kasia";
       def sql = "SELECT (firstname) AS ff, lastname " +
           "FROM employee WHERE firstname = :a";

       def reader = dbcmd.ExecuteReader(System.Data.CommandBehavior.SchemaOnly);
       Console.WriteLine("query executed...");
       def _S = reader.GetSchemaTable ();
       foreach(myRow : System.Data.DataRow in _S.Rows){
         Console.WriteLine (myRow["ColumnName"].ToString () + " : " +
                            myRow["DataType"].ToString ());
//         foreach(myCol : System.Data.DataColumn in _S.Columns){
//           Console.WriteLine(myCol.ColumnName + ":  " + myRow[myCol].ToString ());
//         }
       };
//       foreach (r : System.Data.DataRow in
//       foreach (c : System.Data.DataColumn in _S.Columns)

       while(reader.Read()) {
//            def firstname = (reader["firstname"] :> string);
//            def lastname = (reader["lastname"] :> string);
            def firstname = reader.GetString (0);
            def lastname = reader.GetString (1);
            Console.WriteLine("Name: " + firstname + " " + lastname);
       };
       Console.WriteLine("output written...");

       // clean up
       reader.Close();
//       dbcmd.Dispose();

       Nemerle.Data.Npgsql.ExecuteReaderLoop ("SELECT * FROM employee WHERE"
                                              " firstname = $a", dbcon, {
         Nemerle.IO.printf ("%s %s\n", firstname, lastname)
       });

       def tt = 4; def ty = "dfd4";
       /// CREATE TABLE intstr (a INT4, b VARCHAR(32));
       Nemerle.Data.Npgsql.ExecuteReaderLoop ("SELECT a AS liczba, b,"
          " COUNT(*) AS ilosc FROM intstr " //*)
          "WHERE a = $tt or b = $ty GROUP BY a, b", dbcon, {
         Nemerle.IO.printf ("%d %s\n", liczba, b);
         System.Console.WriteLine (ilosc)
       });
       Nemerle.IO.printf ("%d\n", Nemerle.Data.Npgsql.ExecuteScalar
                          ("SELECT MAX(a) FROM intstr", dbcon));

/*                          
       Nemerle.Data.Npgsql.ExecuteReaderLoop ("INSERT INTO intstr VALUES (1, '2');"
                                              " SELECT * FROM intstr;", conn, { 
         ()
       });
*/
       dbcon.Close();
    }
 }
