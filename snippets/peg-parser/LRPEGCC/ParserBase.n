using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;
using Nemerle.Imperative;

using System.Text;
using System;
using SCG = System.Collections.Generic;

namespace LRPEGCC
{
  /// <summary>
  /// 
  /// RetExprType - Type of parsing result (i.e. AST)
  /// </summary>
  public abstract class ParserBase[RetExprType]
  {    
    // It is unused
    // [Accessor(flags = Protected)]
    // private _cache : System.Collections.Generic.Dictionary[int, int] = System.Collections.Generic.Dictionary();
        
    // this field stores a list of terminal and nonterminal symbols needed for one calulation of next nonterminal rule.
    protected mutable _capturedTokens : list[Token[RetExprType]] = [];
    
    // this data is to be parsed by subclass
    protected _text : string;
    
    private mutable _result : RetExprType;    
    private mutable _parsedSymbolsCount : int;
    private mutable _isParsed : bool = false;    
    
    public Result : RetExprType
    {
      get
      {
        unless(_isParsed)
          Parse();
          
        _result
      }
    }
    
    public ParsedSymbolsCount : int
    {
      get
      {
        unless(_isParsed)
          Parse();
            
        _parsedSymbolsCount
      }
    }
    
    public this(text : string)
    {
      _text = text;
    }
    
    protected GetChar(pos : int) : char
    {
      _text[pos];
    }
    
    protected CheckTextLength(pos : int) : bool
    {
      pos < _text.Length;
    }   
    
    private Parse() : void
    {
      unless(_isParsed)
      {
        _parsedSymbolsCount = DoParse();
        _result = (_capturedTokens.Head :> Token[RetExprType].NonTerminalToken).ComputedValue;
      }
    }
        
    // this method is to be generated by macro "PegGrammar"
    protected abstract DoParse() : int;   
    
    // TODO: replace 'ruleName : string' by 'rule : LRPEGCC.Rule'
    protected abstract DoGenerateResult(ruleName : string, tokens : list[Token[RetExprType]]) : RetExprType; 
  }
}
