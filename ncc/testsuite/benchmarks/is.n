using Nemerle.Diagnostics;

interface I { }
class A : I { }
class B : A { }
class C : B { }


module Test {
  mutable ar : array[object];
  mutable res : int;

  is_noop (times : int) : void
  {
    mutable cnt = 0;
    for (mutable i = 0; i < times; ++i)
      for (mutable j = 0; j < 1000; ++j)
        when (ar[j] != null)
          ++cnt;
    res += cnt;
  }

  is_interface (times : int) : void
  {
    mutable cnt = 0;
    for (mutable i = 0; i < times; ++i)
      for (mutable j = 0; j < 1000; ++j)
        when (ar[j] is I)
          ++cnt;
    res += cnt;
  }

  is_type_A (times : int) : void {
    mutable cnt = 0;
    for (mutable i = 0; i < times; ++i)
      for (mutable j = 0; j < 1000; ++j)
        when (ar[j] is A)
          ++cnt;
    res += cnt;
  }

  
  is_type_C (times : int) : void {
    mutable cnt = 0;
    for (mutable i = 0; i < times; ++i)
      for (mutable j = 0; j < 1000; ++j)
        when (ar[j] is C)
          ++cnt;
    res += cnt;
  }

  
  Main () : void {
    ar = array (1000);
    def obj = object();
    def a = C();
    for (mutable i = 0; i < 1000; ++i) {
      if (i % 3 == 0)
        ar[i] = a;
      else
        ar[i] = obj;
    }
    
    time is_interface (100000);
    time is_type_A (100000);
    time is_type_C (100000);
    time is_noop (100000);
  }
}

