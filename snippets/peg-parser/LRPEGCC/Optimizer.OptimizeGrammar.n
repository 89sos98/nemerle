using System;
using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

namespace LRPEGCC
{
  partial internal class Optimizer
  {
    public static CalcRulesWeights(grammar : Grammar) : Map[RuleRef, option[int]]
    {
      def getRuleWeight(name : RuleRef, weights : Map[RuleRef, option[int]]) : option[int] * Map[RuleRef, option[int]]
      {
        def calc(weights, rule)
        {
          def add(_, _)
          {
            | (Some(weight1), Some(weight2)) => Some(weight1 + weight2);
            | _ => None();
          }
          def (weight, weights) = match (rule : Rule)
          {
            | Call(name)               =>
              getRuleWeight(name, weights);

            | Choice(rules)
            | Sequence(rules)          =>
              def fn(rule, (weight1, weights))
              {
                def (weight2, weights) = calc(weights, rule);
                (add(weight1, weight2), weights);
              }

              rules.Fold((Some(0), weights), fn);

            | Scope(_, rule)
            | Capture(_, rule)
            | RepeatMin(_, rule)
            | RepeatMinMax(_, _, rule)
            | Not(rule)
            | And(rule)                =>
              calc(weights, rule);

            | Chars | Fsm
            | ExtensionPoint           =>
              (Some(0), weights);
          }
          (add(weight, Some(1)), weights);
        }

        if (weights.Contains(name))
        {
          (weights.Get(name), weights)
        }
        else
        {
          def weights = weights.Add(name, None());
          def rule = grammar.GetRule(name);
          def (weight, weights) = calc(weights, rule);
          (weight, weights.Replace(name, weight))
        }
      }
      grammar.Names.Fold(Map(), (name, weights) =>
      {
        def (_, weights) = getRuleWeight(name, weights);
        weights;
      });
    }

    public static OptimizeGrammar(grammar : Grammar) : Grammar
    {
      def weights = CalcRulesWeights(grammar);
      grammar.TransformRules(rule => OptimizeRule(rule, grammar, weights));
    }
  }
}
