#! /bin/sh
#
# Copyright (c) 2003 The University of Wroclaw.
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#    1. Redistributions of source code must retain the above copyright
#       notice, this list of conditions and the following disclaimer.
#    2. Redistributions in binary form must reproduce the above copyright
#       notice, this list of conditions and the following disclaimer in the
#       documentation and/or other materials provided with the distribution.
#    3. The name of the University may not be used to endorse or promote
#       products derived from this software without specific prior
#       written permission.
# 
# THIS SOFTWARE IS PROVIDED BY THE UNIVERSITY ``AS IS'' AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
# OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
# NO EVENT SHALL THE UNIVERSITY BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
# TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

############################################################
# VARIABLES
############################################################

# this variable is used to return values from functions
result=

config_log="configure.log"

python=
install="install"

prefix="/usr/local"
bindir="$prefix/bin"
mandir="$prefix/man"

tmp_dir=
cs_tmp_file=
cs_tmp_out=

############################################################
# FUNCTIONS
############################################################

abort () {

    echo
    echo
    echo "*** $@ ***"
    echo "*** Check $config_log for details. ***"
    echo
    echo "Aborting..."
    rm -f $config_mak
    exit 1
}

echo_check_for () {

    echo "--------------- Checking for $@ ---------------" >> $config_log
    echo -n "Checking for $@... "
}


echo_check_if () {

    echo "--------------- Checking if $@ ----------------" >> $config_log
    echo -n "Checking if $@... "
}


echo_result () {

    echo "Result: $@" >> $config_log
    echo "-----------------------------------------------" >> $config_log
    echo >> $config_log
    echo "$@"
}


try_execute () {

    echo "Trying execute: $1" >> $config_log
    $1 --version > /dev/null 2>&1
    
    if test "$?" = 127; then
	echo "Execution of $1 failed." >> $config_log
	return 0
    else
	echo "Execution of $1 succeeded." >> $config_log
	return 1
    fi
}


check_exec () {

    found=0
    for x in $@; do
	if try_execute "$x"; then
	    continue
	else
	    found=1
	    break
	fi
    done

    if test $found = 0; then
	result=
	echo_result "not found"
    else
	result="$x"
	echo_result "$x"
    fi
}


try_compile () {

    echo "<<<<<<<<<<<<<<<" >> $config_log
    cat $cs_tmp_file >> $config_log
    echo ">>>>>>>>>>>>>>>" >> $config_log

    rm -f $cs_tmp_out
    $csc -out:$cs_tmp_out $cs_tmp_file >> $config_log 2>&1
    rm -f $cs_tmp_file

    if test -f "$cs_tmp_out"; then
	return 0
    else
	return 1
    fi
}


try_compile_and_run () {

    try_compile
    
    if test -f "$cs_tmp_out"; then
	$engine $cs_tmp_out
	if test "$?" -gt 0; then
	    echo_result "no"
	    return 1
	else
	    echo_result "yes"
	    return 0
	fi
    else
	echo_result "no"
	return 1
    fi
}


############################################################
# PARAMETERS SCAN
############################################################

for i in $@; do
    if test "$i" = "--help" || test "$i" = "-help" || test "$i" = "-h"; then
	cat << EOF

Usage: $0 [OPTIONS]...

Defaults for the options are specified in brackets.

Configuration:
  -h, --help            display this help and exit

Installation directories:
  --prefix=DIR          use this prefix for installing Nemerle [/usr/local]
  --bindir=DIR          use this prefix for installing executables 
                        [PREFIX/bin]
  --mandir=DIR          use this prefix for installing manpages [PREFIX/man]

Miscellaneous options:
  --net-engine=ENGINE   use this .NET engine
  --csc=COMPILER        use this C# compiler
  --install-path=PATH   the path to a custom install program

EOF
	exit 0
    fi
done



for ac_option do

    case "$ac_option" in

	--prefix=*)
	    prefix=`echo $ac_option | cut -d '=' -f 2`
	    bindir="$prefix/bin"
	    mandir="$prefix/man"
	    ;;
	--bindir=*)
	    bindir=`echo $ac_option | cut -d '=' -f 2`
	    ;;
	--mandir=*)
	    mandir=`echo $ac_option | cut -d '=' -f 2`
	    ;;
	
	--net-engine=*)
	    engine=`echo $ac_option | cut -d '=' -f 2`
	    ;;
	--csc=*)
	    csc=`echo $ac_option | cut -d '=' -f 2`
	    ;;
	--install-path=*)
	    install=`echo $ac_option | cut -d '=' -f 2 | sed 's/\/$//'`"/install"
	    ;;
	
	*)
	    echo "Unknown parameter: $ac_option"
	    exit 1
	    ;;
    esac
done
	    


############################################################
# INITIALIZATION
############################################################

rm -f $config_log $config_mak

for tmp_dir in "$TMPDIR" "$TEMPDIR" "/tmp"; do
    if test -z $i; then
	continue
    fi
    if test -d $i; then
	break
    fi
done
cs_tmp_file="${tmp_dir}/nemerle-in$$.cs"
cs_tmp_out="${tmp_dir}/nemerle-out$$.exe"

############################################################
# TESTS
############################################################


if test -z "$engine"; then
    echo_check_for ".NET environment"
    check_exec mono
    engine=$result
fi
if test -z "$engine"; then
    abort "Haven't found any .NET environment on your system."
fi



if test -z "$csc"; then
    echo_check_for "C# compiler"
    check_exec mcs csc cscc
    csc=$result
fi
if test -z "$csc"; then
    abort "Haven't found any C# compiler on your system."
fi



echo_check_if "C# compiler works"
cat > $cs_tmp_file << EOF
class MainClass {
    public static void Main () {}
}
EOF
try_compile_and_run
if test "$?" = 1; then
    abort "Your C# compiler seems to be broken."
fi



echo_check_for "Python version"
for i in python2.3 python; do
    str=`$i -V 2>&1`
    if test "$?" -gt 0; then
	continue
    fi
    
    ver=`echo $str | sed 's/.* \([0-9]\.[0-9]\).*/\1/g'`

    case $ver in
	2.3)
	    echo_result "$ver, ok"
	    python=$i
	    ;;
	*)
	    echo_result "$ver, too_old"
	    ;;
    esac
    break
done


echo_check_for "xspp"
if try_execute xspp; then
    echo_result no
else
    echo_result yes
fi
xspp=xspp


echo_check_for "xsltproc"
if try_execute xsltproc; then
    echo_result no
else
    echo_result yes
fi
xsltproc=xsltproc


echo_check_for "xmllint"
if try_execute xmllint; then
    echo_result no
else
    echo_result yes
fi
xmllint=xmllint


############################################################
# CONFIG GENERATION
############################################################

echo "Creating config.mak"

cat > config.mak <<EOF
# Generated by configure

NET_ENGINE = $engine
CSC        = $csc

PYTHON  = $python

INSTALL = $install

prefix  = $prefix
BINDIR  = $bindir
MANDIR  = $mandir

EOF



echo "Creating ncc/ncc"
cat > ncc/ncc <<EOF
#! /bin/sh
$engine $bindir/ncc.exe "\$@"
EOF
chmod +x ncc/ncc
